generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String              @id @default(uuid())
  oktaId                  String              @unique
  email                   String              @unique
  username                String              @unique
  firstName               String?
  lastName                String?
  avatarUrl               String?
  authProvider            String              @default("okta")
  emailVerified           Boolean             @default(true)
  status                  String              @default("active")
  isAdmin                 Boolean             @default(false)
  walletBalance           Float               @default(0.0)
  walletCurrency          String              @default("eur")
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  lastLoginAt             DateTime?
  displayName             String?
  phoneNumber             String?
  pickSets                PickSet[]
  sessions                Session[]
  ownedSquads             Squad[]             @relation("SquadOwner")
  squadMembers            SquadMember[]
  squadMessages           SquadMessage[]
  squadPayments           SquadPayment[]
  walletTransactions      WalletTransaction[]
  pushSubscriptions       PushSubscription[]
  notificationLogs        NotificationLog[]
  squadJoinRequests       SquadJoinRequest[]
  respondedJoinRequests   SquadJoinRequest[]  @relation("JoinRequestResponder")
  sixNationsAnswers       SixNationsAnswer[]

  @@index([email])
  @@index([username])
  @@index([oktaId])
  @@index([status])
  @@index([isAdmin])
}

model Session {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  userAgent String?
  ipAddress String?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Game {
  id         String     @id
  startAtUtc DateTime
  weekId     String
  homeTeam   String
  awayTeam   String
  homeScore  Int?
  awayScore  Int?
  completed  Boolean    @default(false)
  sport      String     @default("nfl")
  lines      GameLine[]
  picks      Pick[]

  @@index([weekId])
  @@index([sport])
  @@index([sport, weekId])
}

model GameLine {
  gameId       String
  spread       Float
  source       String
  fetchedAtUtc DateTime
  game         Game     @relation(fields: [gameId], references: [id])

  @@id([gameId, source, fetchedAtUtc])
}

model PickSet {
  id              String        @id @default(uuid())
  userId          String
  weekId          String
  submittedAtUtc  DateTime?
  lockedAtUtc     DateTime?
  tiebreakerScore Int?
  status          String        @default("draft")
  sport           String        @default("nfl")
  picks           Pick[]
  user            User          @relation(fields: [userId], references: [id])

  @@unique([userId, weekId, sport])
  @@index([userId])
  @@index([weekId])
  @@index([status])
  @@index([sport])
  @@index([sport, weekId])
}

model Pick {
  id           String     @id @default(uuid())
  pickSetId    String
  gameId       String
  choice       String
  spreadAtPick Float
  lineSource   String
  createdAtUtc DateTime   @default(now())
  status       String     @default("pending")
  result       String?
  payout       Float?
  odds         Int?
  game         Game       @relation(fields: [gameId], references: [id])
  pickSet      PickSet    @relation(fields: [pickSetId], references: [id])

  @@unique([pickSetId, gameId])
}

model Squad {
  id              String             @id @default(uuid())
  name            String
  description     String?
  imageUrl        String?
  joinCode        String             @unique
  ownerId         String
  maxMembers      Int                @default(10)
  potEnabled      Boolean            @default(false)
  potAmount       Float?
  potCurrency     String             @default("eur")
  potDeadline     DateTime?
  stripePriceId   String?
  stripeProductId String?
  sport           String             @default("nfl")
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  owner           User               @relation("SquadOwner", fields: [ownerId], references: [id])
  members         SquadMember[]
  messages        SquadMessage[]
  payments        SquadPayment[]
  joinRequests    SquadJoinRequest[]

  @@index([sport])
}

model SquadMember {
  id         String    @id @default(uuid())
  squadId    String
  userId     String
  role       String    @default("member") // Use string instead of enum
  lastReadAt DateTime?
  joinedAt   DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id])
  squad      Squad     @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@unique([squadId, userId])
}

model SquadJoinRequest {
  id          String    @id @default(uuid())
  squadId     String
  userId      String
  status      String    @default("pending") // "pending" | "approved" | "rejected"
  message     String?   // Optional message from user
  requestedAt DateTime  @default(now())
  respondedAt DateTime?
  respondedBy String?   // userId of admin who approved/rejected
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])
  squad       Squad     @relation(fields: [squadId], references: [id], onDelete: Cascade)
  responder   User?     @relation("JoinRequestResponder", fields: [respondedBy], references: [id])

  @@unique([squadId, userId])
  @@index([squadId])
  @@index([userId])
  @@index([status])
}

model SquadPayment {
  id              String        @id @default(uuid())
  squadId         String
  userId          String
  amount          Float
  currency        String
  stripePaymentId String?
  stripeSessionId String?
  status          String        @default("pending")
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  user            User          @relation(fields: [userId], references: [id])
  squad           Squad         @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@unique([squadId, userId])
  @@index([squadId])
  @@index([userId])
}

model WalletTransaction {
  id              String   @id @default(uuid())
  userId          String
  amount          Float
  currency        String   @default("eur")
  type            String
  description     String?
  stripePaymentId String?
  status          String   @default("pending")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
  @@index([status])
}

model SquadMessage {
  id        String   @id @default(uuid())
  squadId   String
  userId    String
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  squad     Squad    @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@index([squadId])
  @@index([userId])
  @@index([createdAt])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  endpoint  String   @unique
  p256dh    String   // Public key
  auth      String   // Auth secret
  userAgent String?  @map("user_agent") // Browser info
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  active    Boolean  @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
  @@index([userId])
  @@index([active])
}

model NotificationLog {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  type      String    // "pick_reminder", "score_update", "window_event"
  title     String
  message   String
  sentAt    DateTime  @default(now()) @map("sent_at")
  clicked   Boolean   @default(false)
  clickedAt DateTime? @map("clicked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_logs")
  @@index([userId])
  @@index([type])
  @@index([sentAt])
}

// ====================
// 6 Nations Models
// ====================

model SixNationsRound {
  id          String             @id @default(uuid())
  roundNumber Int                @unique // 1-5
  name        String // e.g., "Round 1", "Round 2"
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean            @default(false) // Only one round can be active at a time
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  matches     SixNationsMatch[]

  @@index([roundNumber])
  @@index([isActive])
}

model SixNationsMatch {
  id            String               @id @default(uuid())
  roundId       String
  matchNumber   Int // 1-3 within the round
  homeTeam      String
  awayTeam      String
  matchDate     DateTime
  venue         String?
  homeScore     Int?
  awayScore     Int?
  completed     Boolean              @default(false)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  round         SixNationsRound      @relation(fields: [roundId], references: [id], onDelete: Cascade)
  questions     SixNationsQuestion[]

  @@unique([roundId, matchNumber])
  @@index([roundId])
  @@index([matchDate])
}

model SixNationsQuestion {
  id              String             @id @default(uuid())
  matchId         String
  questionNumber  Int // 1-3 within the match
  questionText    String
  questionType    String // "multiple_choice" | "yes_no"
  options         Json? // For multiple choice: ["Option 1", "Option 2", "Option 3"]
  correctAnswer   String? // The correct answer (set after match completes)
  points          Int                @default(1) // Points awarded for correct answer
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  match           SixNationsMatch    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  answers         SixNationsAnswer[]

  @@unique([matchId, questionNumber])
  @@index([matchId])
}

model SixNationsAnswer {
  id         String             @id @default(uuid())
  questionId String
  userId     String
  answer     String // User's selected answer
  isCorrect  Boolean? // Calculated after match completes and correct answer is set
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  question   SixNationsQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([questionId, userId])
  @@index([questionId])
  @@index([userId])
}

model SixNationsAuditLog {
  id          String   @id @default(uuid())
  action      String   // "set_correct_answer", "clear_correct_answer", "update_match_score", "answer_submitted", "answer_rejected_locked"
  performedBy String   // userId of who did the action
  targetType  String   // "question", "match", "answer"
  targetId    String   // ID of the affected record
  details     Json?    // Flexible payload: old/new values, reason, etc.
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([performedBy])
  @@index([targetId])
  @@index([createdAt])
}

model Feedback {
  id           String   @id @default(uuid())
  content      String
  category     String   @default("general") // "bug" | "feature" | "general"
  contactEmail String?
  status       String   @default("new") // "new" | "reviewed" | "resolved"
  adminNotes   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([status])
  @@index([category])
  @@index([createdAt])
}

// Enums converted to strings for compatibility
// UserStatus: "active" | "suspended" | "deleted"
// AuthProvider: "okta"
// PickSetStatus: "draft" | "submitted" | "locked"
// PickChoice: "home" | "away"
// SquadRole: "owner" | "admin" | "member" | "OWNER" | "MODERATOR" | "MEMBER"
// PaymentStatus: "pending" | "completed" | "failed" | "refunded"
// PickStatus: "pending" | "won" | "lost" | "pushed"
// NotificationType: "pick_reminder" | "score_update" | "window_event" | "join_request" | "join_approved" | "join_rejected"
// JoinRequestStatus: "pending" | "approved" | "rejected"
// QuestionType: "multiple_choice" | "yes_no"
