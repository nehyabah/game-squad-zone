# .github/workflows/backend-azure.yml
name: ğŸš€ Backend - Build & Deploy to Azure Container Apps

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/backend-azure.yml"
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ—ï¸ Build & Push to ACR
        run: |
          az acr build \
            --registry squadpotacr \
            --image game-squad-backend:${{ github.sha }} \
            --image game-squad-backend:latest \
            ./backend

      - name: ğŸš€ Deploy to Container Apps
        run: |
          az containerapp update \
            --name squadpot-backend \
            --resource-group SquadPot-Main \
            --image squadpotacr.azurecr.io/game-squad-backend:${{ github.sha }}

      - name: ğŸ¥ Health check
        run: |
          sleep 30
          for i in {1..5}; do
            echo "ğŸ©º Health check attempt $i/5"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 \
              "https://squadpot-backend.greenpebble-cb3440ac.northeurope.azurecontainerapps.io/api/six-nations/rounds")
            if [ "$STATUS" = "401" ]; then
              echo "âœ… Backend is live! (401 = auth working correctly)"
              exit 0
            else
              echo "âš ï¸ Got $STATUS, waiting 20 seconds..."
              sleep 20
            fi
          done
          echo "âŒ Health check failed after 5 attempts"
          exit 1
